name: VPS Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: vps-deploy-${{ github.repository }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Validate deploy secrets
        env:
          VPS_DEPLOY_HOST: ${{ secrets.VPS_DEPLOY_HOST }}
          VPS_DEPLOY_USER: ${{ secrets.VPS_DEPLOY_USER }}
          VPS_DEPLOY_SSH_KEY: ${{ secrets.VPS_DEPLOY_SSH_KEY }}
          VPS_DEPLOY_KNOWN_HOSTS: ${{ secrets.VPS_DEPLOY_KNOWN_HOSTS }}
        run: |
          test -n "$VPS_DEPLOY_HOST"
          test -n "$VPS_DEPLOY_USER"
          test -n "$VPS_DEPLOY_SSH_KEY"
          test -n "$VPS_DEPLOY_KNOWN_HOSTS"

      - name: Configure SSH
        env:
          VPS_DEPLOY_SSH_KEY: ${{ secrets.VPS_DEPLOY_SSH_KEY }}
          VPS_DEPLOY_KNOWN_HOSTS: ${{ secrets.VPS_DEPLOY_KNOWN_HOSTS }}
        run: |
          set -euo pipefail
          install -m 700 -d ~/.ssh
          printf '%s\n' "$VPS_DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf '%s\n' "$VPS_DEPLOY_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Trigger VPS deploy
        env:
          VPS_DEPLOY_HOST: ${{ secrets.VPS_DEPLOY_HOST }}
          VPS_DEPLOY_USER: ${{ secrets.VPS_DEPLOY_USER }}
        run: |
          set -euo pipefail
          ssh \
            -i ~/.ssh/id_ed25519 \
            -o BatchMode=yes \
            -o StrictHostKeyChecking=yes \
            "${VPS_DEPLOY_USER}@${VPS_DEPLOY_HOST}"
